<html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Vanik Karslian - gcp</title><meta name=description content="Personal homepage"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet async href=/fontawesome-free-5.12.1-web/css/all.css><script src=/self/js/lazysizes.min.js async></script><link rel=apple-touch-icon sizes=180x180 href="/self/img/icons/favicon/apple-touch-icon.png?v=2"><link rel=icon type=image/png sizes=32x32 href="/self/img/icons/favicon/favicon-32x32.png?v=2"><link rel=icon type=image/png sizes=16x16 href="/self/img/icons/favicon/favicon-16x16.png?v=2"><link rel=manifest href="/self/img/icons/favicon/site.webmanifest?v=2"><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css integrity=sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.4.1.slim.min.js integrity=sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js integrity=sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js integrity=sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6 crossorigin=anonymous></script><link href="https://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Montserrat:400,700" rel=stylesheet><link rel=stylesheet async href=/self/css/custom.css><script>var remark_config={host:"",site_id:'',components:['embed'],max_shown_comments:20,theme:'light',locale:'EN',show_email_subscription:false};(function(c){for(var i=0;i<c.length;i++){var d=document,s=d.createElement('script');s.src=remark_config.host+'/web/'+c[i]+'.js';s.defer=true;(d.head||d.body).appendChild(s);}})(remark_config.components||['embed']);</script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-73265627-3','auto');ga('send','pageview');}</script><script src=https://code.jquery.com/jquery-1.12.4.min.js integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin=anonymous></script><script src=/self/js/load-photoswipe.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin=anonymous></script><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div></head><body><nav class="navbar navbar-expand-sm navbar-light font-weight-bold border-bottom"><div class=navbar-header><a class=navbar-brand href=https://www.vanik.cologne/en>Vanik Karslian</a></div><button class=navbar-toggler type=button data-toggle=collapse data-target=#collapsibleNavbar>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=collapsibleNavbar><ul class="navbar-nav ml-auto"><li class="nav-item active"><a class="nav-link navbar-dark" href=https://www.vanik.cologne/articles/>Articles</a></li><li class="nav-item active"><a class="nav-link navbar-dark" href=https://www.vanik.cologne/projects/>Projects</a></li><li class="nav-item active"><a class="nav-link navbar-dark" href=https://www.vanik.cologne/podcasts/>Podcasts</a></li><li class="nav-item active"><a class="nav-link navbar-dark" href=https://www.vanik.cologne/photos/>Photos</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" id=dropdownMenuButton role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><i class="fas fa-globe"></i>EN</a><div class="dropdown-menu dropdown-menu-right" aria-labelledby=dropdownMenuButton><a class=dropdown-item><i class="fas fa-flag-en"></i><b>English</b></a></div></li></ul></div></nav><div class="jumbotron header-font border"><div class=text-center><a href=https://www.vanik.cologne/en><img class="lazyload rounded-circle rounded-50 border-white bg-white mx-auto avatar-100" data-src=https://www.vanik.cologne/self/img/avatar_.jpg></a>
<a href=https://www.vanik.cologne/en><h1 class="text-dark font-weight-bold">Vanik Karslian</h1></a><h2>Seniour Data engineer, DevOps.<br>curious</h2></div></div>Travels in time with BigQuery<p>The travels in time are possible in BigQuery. Not many of the BigQuery users
are aware of this feature, although it might be incredibly useful in a daily
life of any data engineer.
There are multiple occasions when you can leverage the benefits of using <code>time travel</code>.
Imagine, you run a data pipeline that breaks the result table, or you
did a mistake in your sql query that destroyed a table used by other team-mates.
In all of these cases you can restore the table from the most recent state.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.sql data-lang=.sql><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span>
<span style=color:#66d9ef>FROM</span> <span style=color:#f92672>`</span>MY_DATASET.MY_TABLE<span style=color:#f92672>`</span>
  <span style=color:#66d9ef>FOR</span> SYSTEM_TIME <span style=color:#66d9ef>AS</span> OF <span style=color:#a6e22e>TIMESTAMP_SUB</span>(<span style=color:#66d9ef>CURRENT_TIMESTAMP</span>(), <span style=color:#66d9ef>INTERVAL</span> <span style=color:#ae81ff>1</span> HOUR);
</code></pre></div><p>here the <code>SYSTEM_TIME</code> defines the exact time stamp from which we would like
to restore the state from, in this case it will be the point of time in 1
hours from now, the format would be &ldquo;2022-11-07 10:44:28.409401 UTC&rdquo;.</p><p>Another case when you would use the <code>time travel</code> more often is the troubleshooting.
If you are wondering when a specific part of the data was introduced to the
table, or how a specific subset of rows was changing over the last 7 days, you can
leverage the following query:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>SELECT</span>
<span style=color:#f92672>*</span> <span style=color:#66d9ef>except</span> (_CHANGE_TYPE,_CHANGE_TIMESTAMP),
_CHANGE_TYPE <span style=color:#66d9ef>AS</span> change_type,
_CHANGE_TIMESTAMP <span style=color:#66d9ef>AS</span> change_time
<span style=color:#66d9ef>FROM</span>
APPENDS(<span style=color:#66d9ef>TABLE</span> MY_DATASET.MY_TABLE, TIMESTAMP_SUB(<span style=color:#66d9ef>CURRENT_TIMESTAMP</span>(), INTERVAL <span style=color:#ae81ff>7</span> <span style=color:#66d9ef>DAY</span>), <span style=color:#66d9ef>NULL</span>);
</code></pre></div><p>here <code>APPENDS</code> returns a table of all rows appended to a table for a given time range</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>APPENDS(
  <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>table</span>,
  start_timestamp <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>,
  end_timestamp <span style=color:#66d9ef>DEFAULT</span> <span style=color:#66d9ef>NULL</span>)
</code></pre></div><p>where</p><ul><li><strong>start_timestamp</strong> - the earliest time at which a change is included in the output,
the NULL would include all the changes since the table creation.</li><li><strong>end_timestamp</strong> is a TIMESTAMP indicating the latest time, exclusive,
at which a change is included in the output. If it is NULL,
all changes made until the start of the query are included.</li></ul><h2 id=the-limitations>The limitations</h2><h4 id=1-storage-time>1. Storage time</h4><p>BigQuery can be configured to store from 2 up to 7 days of history. The
default configuration is 7 days.
In case if the data is not available anymore, you will get the following error</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-.sql data-lang=.sql>Invalid snapshot <span style=color:#66d9ef>time</span> <span style=color:#ae81ff>1601168925462</span> <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>table</span>
MY_PROJECT:MY_DATASET.MY_TABLE<span style=color:#f92672>@</span><span style=color:#ae81ff>1601168925462</span>. Cannot <span style=color:#66d9ef>read</span> <span style=color:#66d9ef>before</span> <span style=color:#ae81ff>1601573410026</span>.
</code></pre></div><p>There are several occasions when you would like to have a longer time window.
In those cases the BigQuery <a href=https://cloud.google.com/bigquery/docs/table-snapshots-intro>snapshots</a>
would be a better option.</p><h4 id=2-row-level-security>2. Row Level Security</h4><p>If you have tables with row level security configured, then you would need to have
Admin priviliges to these tables to access the functionality of the <code>time travel</code>.
Particularly, the roles:</p><ul><li><code>bigquery.rowAccessPolicies.overrideTimeTravelRestrictions</code></li><li><code>roles/bigquery.admin</code></li></ul><p>on the table level are required.</p><h2 id=summary>Summary</h2><p>The <code>time travel</code> is a powerful feature of the BigQuery, it might come in
handy on emergency situations as well as in a daily Data Engineering routine.
And as many other tools it requires some conciseness.
It needs to be used wisely, since the
storage and queries will affect the end cost of the usage.</p>Takeouts on new GCP products DataPlex and Analytics Hub<p>Google has recently introduced new products <a href=https://cloud.google.com/blog/products/data-analytics/build-a-data-mesh-on-google-cloud-with-dataplex-now-generally-available>DataPlex</a>
and <a href=https://cloud.google.com/blog/products/data-analytics/analytics-hub-data-exchange-now-in-public-preview>Analytics Hub</a> aiming to help engineers in building a modern data engineering stack.
With this writing, I&rsquo;d like to share my first impressions working with them.</p><p>Let&rsquo;s start with DataPlex first.</p><p>Google promotes it as a data fabric, helping to unify distributed data and automate data management by building a domain-oriented data mesh.</p><p>The idea seems to be very nice, data might be stored in multiple GCP projects and Dataplex will govern and manage it without any data movement.</p><p>Let&rsquo;s dive deeper and see how it&rsquo;s implemented.</p><p>First, we need to create a new lake. Additionally, we can specify if we want to enable Hive Metastore service useful for querying data with instruments such as Presto, Hive, Spark.</p><p><img src=/self/img/2022-05-31-new-gcp-products/create_new_lake.jpg alt></p><p>On the next step we should get familiar with a concept of zones inside our lake.
A zone is a logical group of structured or unstructured data, such as GCS buckets and/or BQ datasets and tables.</p><p>There are 2 zones types available: raw and curated. Raw stores data in any format in GCS or BQ datasets. A curated zone stores structured data in GCS or BQ in certain formats such as Parquet, Avro or ORC.</p><p>So let&rsquo;s see how it works and create one raw and one curated zone.</p><p><img src=/self/img/2022-05-31-new-gcp-products/create_zones.jpg alt>
This will accordingly create 2 datasets in BigQuery: analytics_raw, analytics_curated.</p><p>And now we come to the point where I personally get confused about Dataplex&rsquo;s concept.
I assumed that adding a new table to these datasets will make this table visible in Dataplex &ldquo;Discover&rdquo; or &ldquo;Explore&rdquo; tab.
However, when I added a new table to the raw dataset, nothing has appeared here.</p><p><img src=/self/img/2022-05-31-new-gcp-products/example_table_analytics_raw.jpg alt>
A new table is added to the <code>analytics_raw</code> dataset.</p><p><img src=/self/img/2022-05-31-new-gcp-products/analytics_raw_assets.jpg alt>
However, no assets are shown under <code>analytics-raw</code> and nothing is displayed in catalog either.</p><p>I could go even further and delete the dataset completely from BQ, and it won&rsquo;t affect the zone in Dataplex anyhow. So, I&rsquo;m not sure what&rsquo;s the right relation between a zone in Dataplex and an according dataset in BQ.</p><p>Let&rsquo;s move on and try adding an asset to our zones.<br>Assets help to map data stored in GCS or BQ into a single zone within a lake.</p><p>Here I&rsquo;m adding a dataset <code>marts</code> containing a table <code>currency_rates</code> into the curated zone.
And here, suddenly, I can explore and find this dataset and table within &ldquo;Explore&rdquo; tab in Dataplex.</p><p>It&rsquo;s a mystery to me why the same doesn&rsquo;t work with datasets created per each zone.</p><p><img src=/self/img/2022-05-31-new-gcp-products/curated_zone_asset.jpg alt></p><p>Let&rsquo;s stop here for reviewing Analytics Hub and get back to Dataplex right after it, discussing which features from Analytics Hub might be very useful in Dataplex.</p><p>Analytics Hub is a platform for exchanging data across organization and external data providers.<br>It is based on publish and subscribe model of BigQuery datasets.</p><p>In simple words, you can create a link to a dataset in another project inside yours, allowing to view and query it.<br>Of course, it&rsquo;s not a big difference comparing it to regular grants to users, groups, service accounts or authorized views, however, having a linked dataset in your project makes is great for discovery and access control.</p><p>Here&rsquo;s how it works - there&rsquo;s a new tab in BQ menu, where you can find data exchanges and browse Analytics Hub datasets.</p><p><img src=/self/img/2022-05-31-new-gcp-products/analytics_hub.jpg alt></p><p>Important to mention, that you need to have enough a role Analytics Hub Viewer to a listing you&rsquo;re interested, in order to discover it in Analytics Hub catalog.<br>After you&rsquo;ve found an interesting dataset, you can &ldquo;subscribe&rdquo; to it, then a new linked dataset will appear within your project, which will be a read-mirror of the original dataset.</p><p>In my opinion it&rsquo;s a great improvement, however, it&rsquo;s lacking functionality to preview data (before having access to it) and requesting data owner to give you permissions.</p><p>What&rsquo;s missing to me overall is the information how to combine all the new products together - Dataplex, Analytics Hub, Data Catalog, plus now we have BigTable.
Google provides mainly marketing materials and videos, while in reality many questions or best practices left unanswered.</p><p>Hopefully these products will evolve together into a well-combined environment. Say, I&rsquo;d really want to have an ability of managing access to multiple datasets within a single place, so that anyone within the company could preview the data and request access to it, and then a granted dataset would appear as a link in the requester&rsquo;s project.</p><p>Have you tried any of these new products or have any other thoughts? Please welcome to comments :)</p><footer class="footer card-footer text-secondary mt-auto"><div class=row><div class="col col-sm-9">&copy; 2022 Vanik Karslian</div><div class="col-12 col-sm-3 text-sm-right px-3"><a href=mailto:vanik.karslian@gmail.com class="text-nowrap text-secondary"><i class="fas fa-envelope fa-fw valign-middle" data-hint=Email></i></a><a href=https://www.linkedin.com/in/vanik-karslian/ class="text-nowrap text-secondary"><i class="fab fa-linkedin-in fa-fw valign-middle" data-hint=LinkedIn></i></a><a href=https://github.com/Vanik888 class="text-nowrap text-secondary"><i class="fab fa-github fa-fw valign-middle" data-hint=Github></i></a><a href=https://www.instagram.com/vanik_kars class="text-nowrap text-secondary"><i class="fab fa-instagram fa-fw valign-middle" data-hint=Instagram></i></a><a href=https://t.me/vanik_kars class="text-nowrap text-secondary"><i class="fab fa-telegram fa-fw valign-middle" data-hint=Telegram></i></a></div></div></footer></body></html>